// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String  @id @default(cuid())
  name           String
  email          String  @unique
  password       String
  bio            String?
  description    String?
  profilePicture String?
  country        String?
  website        String?
  location       String?
  twitter        String?
  github         String?
  linkedin       String?
  instagram      String?

  refreshTokens          RefreshToken[]
  posts                  Post[]
  verificationCode       VerificationCode?
  passwordResetTokens    PasswordResetToken[]
  claps                  Clap[]
  comments               Comment[]
  reports                Report[]
  messages               Message[]
  groupChatMembers       GroupChatMember[]
  createdGroupChats      GroupChat[]          @relation("GroupChatCreator")
  notifications          Notification[]       @relation("UserNotifications")
  actorNotifications     Notification[]       @relation("ActorNotifications")
  mentions               MessageMention[]     @relation("UserMentions")
  customLinks            CustomLink[]
  bookmarks              Bookmark[]
  reposts                Repost[]
  sentDirectMessages     DirectMessage[]      @relation("DirectMessageSender")
  receivedDirectMessages DirectMessage[]      @relation("DirectMessageReceiver")
  encryptionKeys         EncryptionKey[]      // User's encryption keys
  postVersions           PostVersion[]
  commentLikes           CommentLike[]

  // Followers relationship
  followers Follow[] @relation("UserFollowers")
  following Follow[] @relation("UserFollowing")

  isOwner        Boolean   @default(false)
  isAdmin        Boolean   @default(false)
  isVerified     Boolean   @default(false)
  isSuspended    Boolean   @default(false)
  suspendedUntil DateTime?

  // J+ Premium Subscription
  isJPlus        Boolean   @default(false)
  jPlusExpiresAt DateTime?
  jPlusTier      String?   @default("supporter") // supporter
  jPlusStartedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Follow {
  id String @id @default(cuid())

  followerId String
  follower   User   @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User   @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  value     String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  deviceInfo String? // Store device/browser info for security
  ipAddress  String? // Store IP address for security tracking
  isRevoked  Boolean  @default(false) // For token revocation

  @@unique([userId, value]) // Allow multiple refresh tokens per user (multi-device support)
  @@index([userId])
  @@index([expiresAt])
  @@index([isRevoked])
}

model Post {
  id          String  @id @default(cuid())
  title       String
  content     String // Markdown content
  excerpt     String?
  coverImage  String?
  published   Boolean @default(false)
  readingTime Int     @default(0) // in minutes
  views       Int     @default(0) // Total views count

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  tags          PostTag[]
  claps         Clap[]
  comments      Comment[]
  notifications Notification[]
  bookmarks     Bookmark[]
  reposts       Repost[]
  versions      PostVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([published])
  @@index([createdAt])
}

model PostVersion {
  id         String   @id @default(cuid())
  postId     String
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  title      String
  content    String
  excerpt    String?
  coverImage String?
  createdBy  String
  user       User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@index([postId])
  @@index([createdBy])
  @@index([createdAt])
}

model Tag {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?

  posts PostTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model PostTag {
  id     String @id @default(cuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId  String
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

model Clap {
  id     String @id @default(cuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id            String         @id @default(cuid())
  content       String
  postId        String
  post          Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId      String? // For nested comments
  parent        Comment?       @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       Comment[]      @relation("CommentReplies")
  notifications Notification[]
  likes         CommentLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model VerificationCode {
  id        String   @id @default(cuid())
  value     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiredAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Report {
  id          String   @id @default(cuid())
  title       String
  description String
  type        String   @default("bug") // bug, feature, other
  status      String   @default("pending") // pending, in_progress, resolved, closed
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  pageUrl     String? // URL where bug was found
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model GroupChat {
  id            String            @id @default(cuid())
  name          String
  description   String?
  logo          String? // Logo/avatar group chat
  banner        String? // Large banner image for explore view
  isPublic      Boolean           @default(true)
  encryptionEnabled Boolean        @default(false) // Enable E2EE for group
  createdBy     String
  creator       User              @relation("GroupChatCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  members       GroupChatMember[]
  messages      Message[]
  notifications Notification[]
  encryptionKeys EncryptionKey[]  // Group encryption keys
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([createdBy])
  @@index([isPublic])
}

model GroupChatMember {
  id          String    @id @default(cuid())
  groupChatId String
  groupChat   GroupChat @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        String    @default("member") // member, admin
  joinedAt    DateTime  @default(now())

  @@unique([groupChatId, userId])
  @@index([groupChatId])
  @@index([userId])
}

model Message {
  id             String           @id @default(cuid())
  content        String
  encryptedContent String? // Encrypted content untuk E2EE
  encryptionKeyId   String? // Reference to encryption key used
  groupChatId    String
  groupChat      GroupChat        @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  userId         String
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type           String           @default("text") // text, image, video, audio
  mediaUrl       String? // URL untuk photo, video, audio
  encryptedMediaUrl String? // Encrypted media URL untuk E2EE
  mediaThumbnail String? // Thumbnail untuk video
  mentions       MessageMention[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  notifications  Notification[]

  @@index([groupChatId])
  @@index([userId])
  @@index([createdAt])
  // For fetching messages per group ordered by time
  @@index([groupChatId, createdAt])
  @@index([encryptionKeyId])
}

model Notification {
  id          String     @id @default(cuid())
  type        String // like, comment, mention, reply
  userId      String // User yang menerima notifikasi
  user        User       @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  actorId     String // User yang melakukan aksi (yang like/comment/mention)
  actor       User       @relation("ActorNotifications", fields: [actorId], references: [id], onDelete: Cascade)
  postId      String? // Post yang terkait (untuk like/comment)
  post        Post?      @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId   String? // Comment yang terkait (untuk comment/reply)
  comment     Comment?   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  messageId   String? // Message yang terkait (untuk mention)
  message     Message?   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  groupChatId String? // Group chat yang terkait (untuk mention)
  groupChat   GroupChat? @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  read        Boolean    @default(false)
  createdAt   DateTime   @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  // For fetching unread notifications per user by newest first
  @@index([userId, read, createdAt])
  @@index([postId])
  @@index([type])
}

model MessageMention {
  id              String   @id @default(cuid())
  messageId       String
  message         Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  mentionedUserId String
  mentionedUser   User     @relation("UserMentions", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@unique([messageId, mentionedUserId])
  @@index([messageId])
  @@index([mentionedUserId])
}

model CustomLink {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label     String // e.g., "Website", "Twitter", "GitHub"
  url       String // The actual URL
  order     Int      @default(0) // For ordering links
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@index([createdAt])
}

model Repost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@index([createdAt])
}

model DirectMessage {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("DirectMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("DirectMessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  content    String
  encryptedContent String? // Encrypted content untuk E2EE
  encryptionKeyId   String? // Reference to encryption key used
  type       String   @default("text") // text, image, video, audio
  mediaUrl   String? // URL untuk photo, video, audio
  encryptedMediaUrl String? // Encrypted media URL untuk E2EE
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([read])
  @@index([createdAt])
  // For conversations between two users ordered by time
  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, senderId, createdAt])
  // For unread counts per receiver
  @@index([receiverId, read, createdAt])
  @@index([encryptionKeyId])
}

model Broadcast {
  id                String   @id @default(cuid())
  title             String
  message           String
  type              String   @default("info")
  theme             String?  @default("default")
  icon              String?
  backgroundColor   String?
  textColor         String?
  borderColor       String?
  particleEffect   String?  // "none", "snow", "confetti", "stars", "hearts", "fireworks", "sparkles"
  particleEffectAfterCountdown String? // Particle effect setelah countdown selesai
  hasCountdown      Boolean  @default(false)
  countdownEndDate  DateTime?
  actionAfterCountdown String? // "hide", "change_message", "redirect"
  messageAfterCountdown String?
  redirectUrlAfterCountdown String?
  isActive          Boolean  @default(true)
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
  @@index([countdownEndDate])
}

model UpdateLog {
  id          String   @id @default(cuid())
  version     String
  title       String
  description String
  changes     String[]
  commitHash  String?
  commitUrl   String?
  author      String?
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([version])
}

model EncryptionKey {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  publicKey     String?  // Base64 encoded public key (ECDH) - null for group keys
  privateKeyEncrypted String? // Encrypted private key (optional, for backup) or encrypted group key
  keyType       String   @default("ecdh") // ecdh, group
  groupChatId   String? // For group chat keys
  groupChat     GroupChat? @relation(fields: [groupChatId], references: [id], onDelete: Cascade)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, groupChatId, keyType])
  @@index([userId])
  @@index([groupChatId])
  @@index([isActive])
}
